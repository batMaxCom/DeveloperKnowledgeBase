# VACUUM

PostgreSQL использует MVCC: каждый `UPDATE/DELETE` создаёт новую версию строки; старая версия остаётся как dead tuple.
`VACUUM` очищает эти «мертвые» кортежи, освобождает место внутри страниц, делает их переиспользуемыми и предотвращает рост таблицы и проблемы с видимостью транзакций.

Если не делать VACUUM регулярно, то:
- таблицы и индексы «раздуваются» (bloat)
- запросы медленнее (больше I/O)
- autovacuum может запустить дорогую операцию anti-wraparound
- возможен wraparound транзакционной системы → потеря данных или аварийная необходимость VACUUM FREEZE

Поэтому `VACUUM` — не опция, а обязательная часть эксплуатации PostgreSQL.

## Типы VACUUM и их поведение
1. VACUUM (обычный)

- Убирает «dead tuples», помечает пространство как reusable (для новых записей).
- Не уменьшает физический размер файла таблицы на диске.
- Работает онлайн — не блокирует чтение/запись (лишь минимальные блокировки).
- Рекомендуется запускать чаще (autovacuum делает это автоматически).

Команда:
```sql
VACUUM table_name;
```

Для диагностики:
```sql
VACUUM VERBOSE table_name;
```

VERBOSE печатает подробный отчёт о количестве удалённых строк и страниц.

2. VACUUM ANALYZE

Делает VACUUM + обновляет статистику (ANALYZE), которые оптимизатор использует при построении планов.
```sql
VACUUM ANALYZE table_name;
```

3. VACUUM FULL

Переписывает таблицу (rewrites), освобождает неиспользуемое пространство на диске → уменьшает размер файла.

Требует `ACCESS EXCLUSIVE` блокировку → другие транзакции ждут.

Дорогая операция, не рекомендуется в обычном режиме на продакшене. Использовать для «очистки» раздувшейся таблицы в maintenance window или `вместо VACUUM FULL` — `pg_repack` (онлайн альтернатива).

Команда:
```sql
VACUUM FULL table_name;
```

3. VACUUM FREEZE
- Специальный вариант, используемый для «замораживания» старых транзакций (prevent wraparound).
- Автовакуум автматически вызывает freeze при необходимости. Редко выполняют вручную, кроме экстренных случаев.

## Autovacuum

Autovacuum - демонический механизм, который автоматически вызывает VACUUM/ANALYZE по таблицам на основе порога числа изменений.

Основные параметры (суть; проверь свои значения через SHOW)
- autovacuum — включение/выключение (обычно ON).
- autovacuum_naptime — пауза между циклами (обычно 1 min).
- autovacuum_max_workers — число одновременных воркеров (обычно 3).
- autovacuum_vacuum_threshold (default ~50) — абсолютный порог «мертвых» строк перед VACUUM.
- autovacuum_vacuum_scale_factor (default ~0.2) — порог = threshold + scale_factor * таблица_size_rows.
- autovacuum_analyze_scale_factor / autovacuum_analyze_threshold — аналогично для ANALYZE.
- autovacuum_freeze_max_age — возраст транзакции, после которого таблица должна быть «заморожена». (важно для предотвращения wraparound).
- log_autovacuum_min_duration — логирование autovacuum, если он занял больше N мс; 0 логирует все, -1 — отключает.

### Когда запускается autovacuum
Autovacuum запускается для таблицы, когда число изменений (inserts/updates/deletes) превышает:
```sql
autovacuum_vacuum_threshold + autovacuum_vacuum_scale_factor * reltuples
```
(приблизительно). Для маленьких таблиц порог фиксированный, для больших — пропорционален.

Это значит: если у тебя очень большая таблица и небольшая активность, autovacuum может срабатывать редко → возможно нужно понизить scale_factor или threshold на уровне таблицы.