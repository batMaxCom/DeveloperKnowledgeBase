# Установка сервера OpenSSH
`systemctl status sshd` - проверить состояние OpenSSH

# Генерирование новых ключей хоста

Существует несколько типов ключей: 
- RSA
- DSA 
- ECDSA
- ED25519

Сначала удалите старые ключи, если они имеются:
`sudo rm /etc/ssh/ssh_host*`

Затем создайте новые:
`sudo ssh-keygen -A`

# Настройка сервера OpenSSH
Для начала убедитесь, что закрытые ключи хоста вашего сервера доступны только root и только для чтения:
`ls -l /etc/ssh/`

Ответ должен быть:
`-r-------- 1 root root  513 Jun 25 10:02 ssh_host_ecdsa_key`

А для публичных:
`-rw-r--r-- 1 root root  179 Jun 25 10:02 ssh_host_ecdsa_key.pub`

`/etc/ssh/sshd_config` - основной файл кофигурации

После изменения конфигурации необходимо перезагрузить службу:
`sudo systemctl reload sshd.server`

Настройте sshd для проверки правильности атрибутов файлов и домашних каталогов пользователей, прежде чем принимать от них запросы на подключение:
`StrictModes yes`

Если у вашего компьютера более одного IP-адреса, то определите, какой адрес или адреса будет прослушивать сервер:
`ListenAddress 192.168.10.15`
`ListenAddress 192.168.10.16`

Используйте только порты выше 1024 и загляните в `/etc/services`, чтобы выбрать неиспользуемые порты, затем добавьте новые порты в `/etc/services`:
`sshd 2022`
`sshd 2023`
Назначить нестандартные порты для подключения к ssh в `/etc/ssh/sshd_config`:
`Port 2022`
`Port 2023`

Можно разрешить доступ только указанным группам (создайте эти группы в `/etc/group`):
`AllowGroups webadmins backupadmins`

Или отказать в доступе каким-то группам с помощью `DenyGroups`.

Отключите возможность входа `с привилегиями root`. 
`Безопаснее` входить в систему `с привилегиями рядового пользователя` и затем использовать `sudo`:
`PermitRootLogin no`

Как вариант, можно `разрешить вход` с привилегиями `root`, но только методом аутентификации `с открытым ключом`:
`PermitRootLogin prohibit-password`

Кроме того, можно отключить вход с паролем `для всех пользователей` и разрешить только аутентификацию `с открытым ключом`:
`PasswordAuthentication no`

Можно запретить вход конкретным пользователям, перечислив их имена или имена хостов или IP-адреса:
`DenyUsers duchess madmax stash@example.com cagney@192.168.10.25`

`AllowUsers` - для того, чтобы разрешить вход ограниченному кругу пользователей

Ограничьте время ожидания, пока пользователь введет свои учетные данные и завершит процедуру входа в систему. По умолчанию 120 секунд:
`LoginGraceTime 90`
Можно также ограничить количество неудачных попыток входа. По умолчанию 6:
`MaxAuthTries 4`

# Проверка синтаксиса конфигурации
`sudo sshd -t` - тест файла конфигурации

# Настройка аутентификации с паролем
`ssh duchess@server1` - подключение как пользователь `duchess` к серверу `server1`

Если у вас одно и то же имя пользователя на обеих машинах, то его можно не указывать и входить в систему так:
`duchess@pc:~$ ssh server1`

Открытый ключ хоста server1 хранится в файле `~/.ssh/known_hosts`

# Аутентификация с открытым ключом
`ssh-keygen -C "backup server2" -f id-server2 -t rsa -b 4096` - создание ключа

`-C`— позволяет добавить комментарий к ключу, который может помочь вспомнить его предназначение;
`-f` — позволяет задать имя ключа, которое может быть любым. Не забывайте, в каком каталоге находитесь в текущий момент; если не в ~/.ssh, то укажите путь;
`-t` — тип ключа: rsa, ecdsa или ed25519;
`-b` — разрядность; этот параметр поддерживается только для ключей rsa. Значение по умолчанию — 2048, максимальная разрядность — 4096. Чем больше разрядность, тем больше вычислительных ресурсов требуется на обработку, но, честно говоря, вы едва ли заметите какую-либо разницу при использовании 4096-разрядного ключа, разве что на старом и слабом оборудовании или на очень загруженных серверах;
`-i` — сообщает SSH-клиенту, какой ключ должен применяться. Если у вас несколько ключей, то вы должны использовать этот параметр. При наличии нескольких открытых ключей можно столкнуться с сообщением об ошибке Too many authentication failures (Слишком много ошибок аутентификации), если не указать один ключ, поскольку SSH будет пробовать их все, если не указан один конкретный.

`Следующий шаг` — скопировать новенький ключ на удаленный компьютер.
При этом у вас уже должен быть `настроен SSH-доступ` к удаленному компьютеру, например, `с аутентификацией с ключом` хоста.

Утилита ssh-copy-id гарантирует копирование открытых ключей в нужное место, то есть в ~/.ssh/authorized_keys на удаленном хосте, в нужном формате и с нужными разрешениями. Она также гарантирует, что ваш закрытый ключ не будет скопирован по ошибке.
Чтобы скопировать ваш открытый ключ на сервер:
`ssh-copy-id -i id-server1 duchess@server1`

Выполнить вход:
`ssh -i id-server1 duchess@server1`

# Управление несколькими открытыми ключами
Для простого управления несколькими ключами необходимо создать файл конфигурации `~/.ssh.config` со следующим содержанием:
```
Host server2
    HostName server2
    User duchess
        IdentityFile ~/.ssh/id-server2
        IdentitiesOnly yes
```

`ssh server2` - подключение

В этот файл можно добавить все используемые вами открытые ключи, например:
```
Host server3
    HostName server3
    User duchess
        IdentityFile ~/.ssh/id-server3
        IdentitiesOnly yes

Host server3
    HostName server3
    User madmax
        IdentityFile ~/.ssh/id-server3
        IdentitiesOnly yes
```

Где:
- Строка `Host` определяет начало блока настроек для каждого отдельного хоста. Это метка, которая будет использоваться для входа в систему, и она может быть любой строкой.
`HostName` — имя хоста удаленного компьютера, полное доменное имя или IP-адрес.
`User` — имя пользователя на удаленной машине.
`IdentityFile` — полный путь к файлу с вашим открытым ключом.
`IdentitiesOnly` yes — указывает ssh использовать настройки в ~/.ssh/config или из параметров командной строки, а не из других источников, если они есть.

# Изменение парольной фразы
`ssh-keygen -p -f ~/.ssh/id-server2` - для изменения парольной фразы закрытого ключа

Парольные фразы нельзя восстановить. Если вы забудете ее, то вам останется только создать новый ключ с новой парольной фразой.

# Открытие сеанса SSH и запуск команды одной строкой
`ssh mailadmin@server2.example.com sudo systemctl restart postfix`

# Монтирование удаленной файловой системы через sshfs
`sudo apt install sshfs` - установка пакета

`mkdir sshfs` - создать каталог для монтирования

`sshfs duchess@server2: sshfs/` -  Это пример монтирует `домашний каталог` `duchess@server2` в каталог `sshfs` на `duchess@pc`
`sshfs duchess@server2:/home/duchess/arias sshfs/` - смонтировать любой каталог
`fusermount -u sshfs/` - завершив работу с удаленной файловой системой, размонтируйте ее

Если сетевое соединение ненадежно, подскажите утилите sshfs, что она должна автоматически восстанавливать подключение в случае разрыва:
`duchess@pc:~$ sshfs duchess@server2:/home/duchess/arias sshfs/ -o reconnect`