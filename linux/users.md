# Users & Groups
В Linux есть два типа пользователей: `пользователи-люди` и `системные пользователи`. 
Каждый из них имеет `уникальный идентификатор (User ID, UID)` и по крайней мере один `идентификатор группы (Group ID, GID)`. 
Каждый пользователь входит в одну основную группу и может входить в несколько дополнительных.

Группы определяют `привелегии`. Привилегии `управляют доступом к файлам и командам` и являются основой безопасности системы.

`Пользователи-люди` делятся на две категории: пользователь `суперпользователя`(root, имеющие неограниченные права) и `обычные`

`Системные пользователи` — это системные службы и процессы. 
Учетные записи системных пользователей нужны лишь для `управления привилегиями`.

`/etc/passwd` - увидеть всех пользователей в системе
`/etc/group` - увидеть все группы в системе

```bash
useradd — создает новых пользователей;
groupadd — создает новые группы;
userdel — удаляет пользователей;
groupdel — удаляет группы;
usermod — изменяет настройки существующего пользователя;
passwd — создает и изменяет пароли.
```

В Linux есть три типа идентификаторов пользователя/группы:
- реальный UID/GID;
- эффективный UID/GID;
- сохраненный UID/GID.

`Реальный идентификатор` — это UID и GID основной группы, присвоенные пользователю при создании. Это то, что вы видите, когда запускаете команду id без параметров от своего имени.
`Эффективный идентификатор` — это UID, используемый для запуска процесса, которому требуются привилегии, отличные от привилегий пользователя,запускающего процесс. 
Примером может служить команда passwd, которая требует привилегий суперпользователя и применяет специальные режимы разрешений, чтобы дать пользователям возможность изменять свои собственные пароли.
`Сохраненный идентификатор` используется процессами, которым требуются повышенные привилегии, обычно привилегии root.

`id` - узнать собственные UID и GID
`id madmax` - узнать UID и GID другого пользователя

Команда id поддерживает несколько параметров:
`-u` выводит эффективный числовой UID;
`-g` выводит эффективный числовой GID;
`-G` выводит все числовые идентификаторы групп;
`-n` выводит имя пользователя вместо числового идентификатора UID. Этот
параметр можно использовать в комбинации с -u, -g и -G;
`-un` выводит эффективный числовой UID и имя пользователя;
`-gn` выводит имя эффективной группы;
`-Gn` выводит все имена эффективных групп;
`-r` выводит реальный числовой идентификатор вместо эффективного. Этот
параметр можно использовать в комбинации с -u, -g и -G.

## Создание учетной записи для пользователя-человека с помощью команды useradd

`sudo useradd test1` - создать пользователя
`sudo ls -a /home/test1/` - узнать, создалась ли у пользователя домашний каталог
`sudo passwd test1` - назначить пароль пользователю
`sudo passwd -e test1` - создать пароль и попросить сменить его при первом входе
`sudo useradd -mU test2` - создает личную группу (`-m` - позволит создать домашний каталог пользователя, а параметр `-U` — личную группу с именем)

Все `новые учетные` записи пользователей `остаются неактивными` до установки пароля.

Ниже представлено еще несколько полезных параметров:
`-G, --groups` — добавляет пользователя в несколько дополнительных групп, перечисленных через запятую. 

Группы должны существовать к моменту выполнения команды:
`sudo useradd -G group1,group2,group3 test1`

`-c, --comment` — принимает любую текстовую строку и сохраняет ее как полное имя пользователя, комментарий или описание.

Четыре запятых в данном примере определяют пять полей: имя, номер кабинета, рабочий телефон, домашний телефон и прочее/
`useradd -G group1,group2,group3 -c 'Test 1,,,,' test1`

## Создание системной учетной записи с помощью команды useradd
`sudo useradd -rs /bin/false service1` - создаст нового системного пользователя без домашнего каталога, без оболочки входа и с UID из диапазона, предназначенного для системных пользователей

`-r` создает системного пользователя с реальным UID из диапазона, предназначенного для системных пользователей
`-s` задает оболочку входа /bin/false — команду, которая ничего не делает и не позволяет выполнить вход в систему с именем этого пользователя

## Изменение настроек по умолчанию для команды useradd

Настройки команды `useradd` разбросаны по множеству конфигурационных файлов, таких как:
- `/etc/default/useradd`, 
- `/etc/login.defs`
- файлы в каталоге `/etc/skel`

В файле /`etc/default/useradd` находятся следующие настройки. Этот пример взят из openSUSE:
```bash
$ useradd -D

GROUP=100
HOME=/home
INACTIVE=-1
EXPIRE=
SHELL=/bin/bash
SKEL=/etc/skel
CREATE_MAIL_SPOOL=yes
```

`HOME=` - задает каталог по умолчанию для размещения домашних каталогов пользователей. По умолчанию /home
`INACTIVE=-1` - задает срок действия пароля в днях, по истечении которого учетная запись будет заблокирована. Значение 0 сразу же отключает учетную запись, так как срок действия пароля истекает немедленно, а значение –1 запрещает блокирование учетных записей.
`EXPIRE=` назначает конечную дату действия учетной записи в формате YYYY-MM-DD. Например, если установить значение 2021-12-31, то учетная запись будет заблокирована в эту дату. Если параметр EXPIRE= оставить пустым, то это будет означать отсутствие конечной даты.
`SHELL=/bin/bash` назначает командную оболочку по умолчанию. Наиболее широко используется оболочка /bin/bash. Вдобавок в этом параметре можно назначить любую другую командную оболочку, установленную в системе, например: /bin/zsh или /usr/bin/tcsh. Получить список установленных командных оболочек можно с помощью команды cat /etc/shells.
`SKEL=/etc/skel` - определяет каталог с файлами, которые должны автоматически копироваться в домашние каталоги новых пользователей. В большинстве дистрибутивов Linux такие файлы помещаются в /etc/skel. К ним относятся: .bash_logout, .bash_profile, .profile, .bashrc и любые другие файлы, которые должны иметься у новых пользователей. Вы можете отредактировать эти файлы в соответствии со своими требованиями. SKEL — это сокращение от skeleton («каркас, основа»).
`CREATE_MAIL_SPOOL=yes` - пережиток прошлого, и этому параметру всегда следует присваивать значение yes, так как некоторые устаревшие процессы могут все еще нуждаться в нем.

## Настройка каталогов для документов, музыки, видео, изображений и загрузок

Создание этих каталогов является функцией инструмента управления пользовательскими каталогами `X Desktop Group (XDG)`.

Настройки, применяемые по умолчанию ко всем пользователям, находятся в конфигурационном файле `/etc/xdg/user-dirs.defaults`

Пользователь переопределяет свои настройки в директории `~/.config/user-dirs.dirs`

Можно изменить как файл, так и отдельные параметры
```bash
$ xdg-user-dirs-update --set DOWNLOAD $HOME/landing-zone
$ xdg-user-dirs-update --set DESKTOP $HOME/table
$ xdg-user-dirs-update --set DOCUMENTS $HOME/omg-paperwork
$ xdg-user-dirs-update --set MUSIC $HOME/singendance
$ xdg-user-dirs-update --set PICTURES $HOME/piccies
```

Для применения необходимо `выйти из системы и зайти заново`.

`xdg-user-dirs-update --force` - восстановить настройки по умолчанию

## Создание пользовательских и системных групп с помощью команды groupadd

`sudo groupadd musicians` - создать группу
`sudo groupadd -r service1` - создать системную группу

## Добавление пользователей в группы с помощью команды usermod 
`sudo usermod -aG musicians duchess` - добавления пользователя в группу
`sudo usermod -aG musicians,composers,stagehands duchess` - добавление пользователя в несколько групп

Параметры:
- `-a` означает append («добавить в конец»)
- `-G` — group («группа»)

`ВАЖНО!` Если вы забудете параметр `-a` и укажете только `-G`, то все `пользователи, прежде входившие` в группу, `будут исключены` из нее.

`Альтернативное решение` — отредактировать файл `/etc/group` и добавить имя пользователя Duchess во все группы, в которые он должен входить.

## Создание пользователей с помощью команды adduser в Ubuntu
`sudo adduser stash` - пошаговое создание пользователя в дистрибутивах Debian или другой дистрибутив Linux на основе Debian

Настройки по умолчанию для adduser определены в файле `/etc/adduser.conf`, в том числе:
`DSHELL=` — оболочка входа по умолчанию. Чаще других используется оболочка /bin/bash. Кроме того, можно указать любую другую оболочку, установленную в системе, такую как /bin/zsh или /usr/bin/tcsh. Получить список установленных командных оболочек можно с помощью команды cat /etc/shells;
`USERGROUPS=yes` создает личную группу для каждого нового пользователя;
`параметр USERS_GID=100` необходим, только если выбрана настройка USER­GROUPS=no;
`EXTRA_GROUPS=` — это список дополнительных групп для новых пользователей, например: EXTRA_GROUPS="audio video plugdev libvirt";
`ADD_EXTRA_GROUPS=1 `добавляет по умолчанию новых пользователей в группы, перечисленные в EXTRA_GROUPS=.

## Создание системного пользователя с помощью команды adduser в Ubuntu
`sudo adduser --system --no-create-home --group service` - создаст системного пользователя service1 без домашнего каталога и с собственной основной личной группой

## Создание пользовательских и системных групп с помощью команды addgroup
`sudo addgroup composers` - пример создания группы для пользователей-людей
`sudo addgroup --system service1` - создаст системную группу

## Отключение учетной записи пользователя
`sudo passwd -l stash` - временно деактивировать учетную запись
`sudo passwd -u stash` - разблокировать учетную запись

`sudo usermod --expiredate 1 stash` - Когда пользователь попытается войти, он увидит сообщение Your account has expired; please contact your system administrator (Срок действия вашей учетной записи истек, обратитесь к своему системному администратору). 

Чтобы восстановить учетную запись, выполните команду:
`sudo usermod --expiredate -1 stash`

# Удаление пользователя с помощью команды userdel
`sudo userdel stash` - удалить пользователя Stash из /etc/passwd, основной группы и из дополнительных групп в теневых файлах
`sudo userdel -r stash` - `-r`, чтобы удалить домашний каталог пользователя с его содержимым и папку электронной почты

## Удаление пользователя с помощью команды deluser в Ubuntu
`sudo deluser stash` - удаления пользователя Stash из /etc/passwd, а также из основной группы в /etc/group и из дополнительных групп в теневых файлах
`sudo deluser --remove-all-files --backup stash` - пример удаления домашнего каталога пользователя Stash и создания резервной копии всех удаляемых файлов

С помощью параметра --backup-to можно указать другой каталог:
`sudo deluser --remove-all-files --backup-to /user-backups stash`

## Удаление группы с помощью команды delgroup в Ubuntu
`sudo delgroup musicians` - удалит группу

Если нежелательно удалять непустые группы, то добавьте в команду параметр --only-if-empty:
`sudo delgroup --only-if-empty musicians`

## Поиск всех файлов, принадлежащих пользователю
`sudo find / -uid 1007` - отыскать в локальной системе все файлы с определенными значениями UID и GID владельца

Поиск в подкаталогах:
```bash
$ sudo find /etc -uid 1007
$ sudo find /home -uid 1007
$ sudo find /var -uid 1007
```

Поиск файлов, принадлежащих несуществующему пользователю или группе:
`find / -nouser`
`find / -nogroup`

## Использование su для получения привилегий root

Использовать команду su, когда требуется получить привилегии root для администрирования системы:
`su -l`

Параметр `-l` настраивает среду и выполняет переход в домашний каталог пользователя root.

Выполнив команду su без параметра -l, вы останетесь со своей средой:
`su`